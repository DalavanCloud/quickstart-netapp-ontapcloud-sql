{
    "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "This template deploys and configures a NetApp OnCommand Cloud Manager instance, a NetApp ONTAP Cloud instance, and a workload instance based on your choice.  All configuraiton is done for you to create the storage volumes on the ONTAP Cloud system and have them mounted and avaialble to the workload instance.  This template will also deploy everything into a new VPC and public subnet. **WARNING** This template creates Amazon EC2 instance and related resources. You will be billed for the AWS resources used if you create a stack from this template.",
  "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Workload options with ONTAP Cloud HA"
                    },
                    "Parameters": [
                        "Workload"
                    ]
                },
				{
                    "Label": {
                        "default": "ONTAP Cloud HA General Configuration"
                    },
                    "Parameters": [
                        "CompanyName",
                        "CloudManagerUserEmail",
                        "CloudManagerPassword",
						"AvailabilityType",
						"AvailabilityZones",
						"Capacity"
                    ]
                },
				{
                    "Label": {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "CIDRRange",
                        "RemoteAccessCIDR",
						"FloatingIPCluster",
                        "FloatingIPData1",
						"FloatingIPData2"
                    ]
                },
                {
                    "Label": {
                        "default": "Amazon EC2 Configuration"
                    },
                    "Parameters": [
                        "KeyPair"
                    ]
                },
				{
                    "Label": {
                        "default": "AWS Quick Start Configuration"
                    },
                    "Parameters": [
                        "QSS3BucketName",
                        "QSS3KeyPrefix"
                    ]
                }
				
            ],
            "ParameterLabels": {
                "CIDRRange": {
                    "default": "VPC CIDR Range"
                },
				"CompanyName": {
                    "default": "Company Name"
                },
				"KeyPair": {
                    "default": "Key Pair"
                },
                "CloudManagerUserEmail": {
                    "default": "Cloud Manager User Email"
                },
                "CloudManagerPassword": {
                    "default": "Cloud Manager Password"
                },
				"RemoteAccessCIDR": {
                    "default": "Remote Access CIDR"
                },
				"Capacity": {
					"default": "Initial ONTAP Cloud Storage Capacity"
				},
                "QSS3BucketName": {
                    "default": "Quick Start S3 Bucket Name"
                },
                "QSS3KeyPrefix": {
                    "default": "Quick Start S3 Key Prefix"
                },
				"FloatingIPCluster":{
					"default": "Floating IP address for ONTAP Cloud HA Cluster Management"
				},
				"FloatingIPData1":{
					"default": "Floating IP address for NFS and CIFS Data access on ONTAP Cloud HA Node 1"
				},
				"FloatingIPData2":{
					"default": "Floating IP address for NFS and CIFS Data access on ONTAP Cloud HA Node 2"
				},
				"AvailabilityType": {
					"default": "ONTAP High Availability Type"
				},
				"AvailabilityZones": {
					"default": "Availability Zones for ONTAP HA deployment"
				},
				"Workload": {
					"default": "Workload to deploy with ONTAP Cloud HA"
				}
            }
        }
    },
  "Parameters": { 

    "CIDRRange": {
      "Description": "VPCCIDR Range (will be created as a /16 block)",
      "Type": "String",
      "Default": "172.18.0.0",
      "AllowedValues": [ "172.18.0.0", "172.19.0.0", "172.20.0.0", "172.21.0.0", "172.22.0.0", "172.23.0.0" ]
    },
    "CompanyName": {
      "Type": "String",
      "MinLength": "4",
      "Description": "Company name. Should start with alphabetic character and contains only numbers, letters or underscore (_) and up to 35 characters",
      "MaxLength": "35",
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9_]*",
      "ConstraintDescription": "Must start with alphabetic character and contains only numbers, letters or underscore (_) and up to 35 characters"
    },
    "KeyPair": {
      "Type": "AWS::EC2::KeyPair::KeyName",
      "Description": "CloudManager instance will be launched with this KeyPair"
    },
    "CloudManagerUserEmail": {
      "Type": "String",
      "Description": "Email address will be used to login to Cloud Manager"
    },
    "CloudManagerPassword": {
      "Type": "String",
      "Description": "Password will be used to login to Cloud Manager and ONTAP Cloud",
      "NoEcho": "true",
      "MinLength": "4",
      "MaxLength": "20",
      "ConstraintDescription": "Password Min length is 4 and max length is 20"
    },
    "RemoteAccessCIDR": {
      "Description": "CloudManager and Ubuntu access will be allowed from this CIDR range (example for full access: 0.0.0.0/0)",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "Must be a valid CIDR range of the form x.x.x.x/x."
    },
    "Capacity": {
      "Type": "Number",
      "Description": "Capacity required for the initial ONTAP Cloud Storage Volume (up to 2000 GB)",
      "MinValue": "100",
      "MaxValue": "2000",
      "Default": "100",
      "ConstraintDescription": "Database size limit up to 2000 GB"
    },
	"QSS3BucketName": {
      "AllowedPattern": "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$",
      "ConstraintDescription": "Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).",
      "Default": "otc-ha-quickstart-test",
      "Description": "S3 bucket name for the Quick Start assets. This string can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-). Accept default for a bucket already configured.",
      "Type": "String"
    },
    "QSS3KeyPrefix": {
      "AllowedPattern": "^[0-9a-zA-Z-]+(/[0-9a-zA-Z-]+)*$",
      "ConstraintDescription": "Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/). It cannot start or end with a forward slash (/), which is automatically appended.",
      "Default": "netapp/ontapcloud/ha/latest",
      "Description": "S3 key prefix for the Quick Start assets. This prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/). It cannot start or end with a forward slash (/), which is automatically appended. Accept default for standard configuration.",
      "Type": "String"
    },
	"FloatingIPCluster" : {
            "Description" : "The Floating IP address to use for ONTAP Cloud HA Cluster managment, these should be outside of the CIDR blocks for all VPCs in the AWS region where you deploy the HA configuration",
            "Type" : "String",
            "MinLength": "7",
            "MaxLength": "15",            
            "AllowedPattern" : "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})",
            "ConstraintDescription" : "Must be a valid CIDR range of the form x.x.x.x",
			"Default" : "192.168.10.2"
    },
    "FloatingIPData1" : {
            "Description" : "The Floating IP address to use for NFS and CIFS Data on ONTAP Cloud HA Node1",
            "Type" : "String",
            "MinLength": "7",
            "MaxLength": "15",            
            "AllowedPattern" : "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})",
            "ConstraintDescription" : "Must be a valid CIDR range of the form x.x.x.x",
			"Default" : "192.168.10.3"
    },
    "FloatingIPData2" : {
            "Description" : "The Floating IP address to use for NFS and CIFS Data on ONTAP Cloud HA Node2",
            "Type" : "String",
            "MinLength": "7",
            "MaxLength": "15",            
            "AllowedPattern" : "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})",
            "ConstraintDescription" : "Must be a valid CIDR range of the form x.x.x.x",
			"Default" : "192.168.10.4"
    },
	"AvailabilityType": {
          	"Description": "ONTAP High Availability Type",
           	"Type": "String",
            "Default": "SingleAZ",
            "AllowedValues": [
              	"SingleAZ",
               	"MultiAZ"
            ]
        },
	"Workload": {
		"Description": "Choose the workload to deploy with ONTAP",
           	"Type": "String",
            "Default": "None",
            "AllowedValues": [
              	"None",
               	"Ubuntu",
				"SQLServer"
            ]
	},
	"AvailabilityZones": {
		    "Type": "List<AWS::EC2::AvailabilityZone::Name>",
		    "Description": "List of Availability Zones to use for the subnets in the VPC. Note: The logical order is preserved. Choose 1 for Single AZ or 3 for Multi AZ deployment."
	}
   },
   
   "Conditions" : {
    	"CreateMultiAZ": {
     		"Fn::Equals" : [{"Ref" : "AvailabilityType"}, "MultiAZ"]
       	},
		"CreateUbuntuWorkload":{
			"Fn::Equals" : [{"Ref" : "Workload"}, "Ubuntu"]
		},
		"CreateSQLWorkload":{
			"Fn::Equals" : [{"Ref" : "Workload"}, "SQLServer"]
		},
		"GovCloudCondition": {
			"Fn::Equals": [
				{
					"Ref": "AWS::Region"
				},
				"us-gov-west-1"
			]
		}
   },

  "Mappings": {
        "SubnetRanges": {
		  "172.18.0.0": {
			"PublicSubnetAZ1"   : "172.18.1.0/24",
			"PublicSubnetAZ2"   : "172.18.2.0/24",
			"PublicSubnetAZ3"   : "172.18.3.0/24"
		  },
		  "172.19.0.0": {
			"PublicSubnetAZ1"   : "172.19.1.0/24",
			"PublicSubnetAZ2"   : "172.19.2.0/24",
			"PublicSubnetAZ3"   : "172.19.3.0/24"
		  },
		  "172.20.0.0": {
			"PublicSubnetAZ1"   : "172.20.1.0/24",
			"PublicSubnetAZ2"   : "172.20.2.0/24",
			"PublicSubnetAZ3"   : "172.20.3.0/24"
		  },
		  "172.21.0.0": {
			"PublicSubnetAZ1"   : "172.21.1.0/24",
			"PublicSubnetAZ2"   : "172.21.2.0/24",
			"PublicSubnetAZ3"   : "172.21.3.0/24"
		  },
		  "172.22.0.0": {
			"PublicSubnetAZ1"   : "172.22.1.0/24",
			"PublicSubnetAZ2"   : "172.22.2.0/24",
			"PublicSubnetAZ3"   : "172.22.3.0/24"
		  },
		  "172.23.0.0": {
			"PublicSubnetAZ1"   : "172.23.1.0/24",
			"PublicSubnetAZ2"   : "172.23.2.0/24",
			"PublicSubnetAZ3"   : "172.23.3.0/24"
		  }
    }
    },
  "Resources": {
        "VPCStack": {
            "Type": "AWS::CloudFormation::Stack",
			"Properties": {
                "TemplateURL": {
					"Fn::If" : [
					    "CreateMultiAZ", 
							{"Fn::Sub":[ 
								"https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}/submodules/quickstart-aws-vpc/templates/aws-vpc.template",
								{
									"QSS3Region": {"Fn::If":[ "GovCloudCondition", "s3-us-gov-west-1", "s3"]}}]
								},
							{"Fn::Sub":[ 
								"https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}/templates/netapp-otc-ha-newvpc.template",
								{
									"QSS3Region": {"Fn::If":[ "GovCloudCondition", "s3-us-gov-west-1", "s3"]}}]
							}]},	
                "Parameters": {
                    "AvailabilityZones": {
                        "Fn::Join": [
                            ",",
                            {
                                "Ref": "AvailabilityZones"
                            }
                        ]
                    },
                    "KeyPairName": {
                        "Ref": "KeyPair"
                    },
                    "NumberOfAZs": {
                        "Fn::If": [	"CreateMultiAZ", "3", "1" ]
                    },
                    "PublicSubnet1CIDR": {
                        "Fn::FindInMap" : [ "SubnetRanges", { "Ref" : "CIDRRange" }, "PublicSubnetAZ1"]
                    },
                    "PublicSubnet2CIDR": {
                        "Fn::FindInMap" : [ "SubnetRanges", { "Ref" : "CIDRRange" }, "PublicSubnetAZ2"]
                    },
                    "PublicSubnet3CIDR": {
                        "Fn::FindInMap" : [ "SubnetRanges", { "Ref" : "CIDRRange" }, "PublicSubnetAZ3"]
                    },
                    "VPCCIDR": {
						"Fn::Join": [
                        "/",
                        [
                            {
                                "Ref": "CIDRRange"
                            },
                            "16"
                        ]
                    ]
                    },
					"CreatePrivateSubnets": false
                }
            }
        },
        "WorkloadStack": {
            "Type": "AWS::CloudFormation::Stack",
            "DependsOn": "VPCStack",
			"Properties": {
                "TemplateURL": {
                    "Fn::Sub":[ 
						"https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}/templates/netapp-otc-ha-workload.template",
						{
							"QSS3Region": {
								"Fn::If": [
									"GovCloudCondition",
									"s3-us-gov-west-1",
									"s3"
								]}}]
                },
                "Parameters": {
                    "CloudManagerPassword": {
                        "Ref": "CloudManagerPassword"
                    },
					"CloudManagerUserEmail": {
                        "Ref": "CloudManagerUserEmail"
                    },
                    "CompanyName": {
                        "Ref": "CompanyName"
                    },
                    "KeyPair": {
                        "Ref": "KeyPair"
                    },
					"QSS3BucketName" : { 
						"Ref" : "QSS3BucketName" 
					},
					"QSS3KeyPrefix" : { 
						"Ref" : "QSS3KeyPrefix" 
					},
                    "RemoteAccessCIDR": {
                        "Ref": "RemoteAccessCIDR"
                    },
					"AvailabilityType": { 
						"Ref" : "AvailabilityType" 
					},
					"AvailabilityZones": {
                        "Fn::Join": [
                            ",",
                            {
                                "Ref": "AvailabilityZones"
                            }
                        ]
                    },
                    "SubnetId": {
                        "Fn::If" : [
					    	"CreateMultiAZ",
					    	{ "Fn::GetAtt": [
			                    "VPCStack",
			                    "Outputs.PublicSubnet1ID"
			                ]},
					    	{ "Fn::GetAtt": [
			                    "VPCStack",
			                    "Outputs.PublicSubnet"
			                ]}
					  	]
                    },
					"SubnetId2": {
                         "Fn::If" : [
					    	"CreateMultiAZ",
					    	{ "Fn::GetAtt": [
			                    "VPCStack",
			                    "Outputs.PublicSubnet2ID"
			                ]},
					    	{ "Fn::GetAtt": [
			                    "VPCStack",
			                    "Outputs.PublicSubnet"
			                ]}
					  	]
                    },
					"SubnetId3": {
                         "Fn::If" : [
					    	"CreateMultiAZ",
					    	{ "Fn::GetAtt": [
			                    "VPCStack",
			                    "Outputs.PublicSubnet3ID"
			                ]},
					    	{ "Fn::GetAtt": [
			                    "VPCStack",
			                    "Outputs.PublicSubnet"
			                ]}
					  	]
                    },
					"RouteTableID": {
					    	"Fn::GetAtt": [
			                    "VPCStack",
			                    "Outputs.PublicSubnetRouteTable"
			                ]
					 },
					"FloatingIPCluster": {
                        "Ref": "FloatingIPCluster"
                    },
					"FloatingIPData1": {
                        "Ref": "FloatingIPData1"
                    },
					"FloatingIPData2": {
                        "Ref": "FloatingIPData2"
                    },
					"VPCId": {
                        "Fn::GetAtt": [
                            "VPCStack",
                            "Outputs.VPCID"
                        ]
                    },
                    "Capacity": {
                        "Ref": "Capacity"
                    },
					"Workload": { 
						"Ref" : "Workload" 
					}
                }
            }
		}
    },
	"Outputs" : {
		"CloudManagerURL" : {
            "Description" : "CloudManager URL",
			"Value": { "Fn::GetAtt": [ "WorkloadStack", "Outputs.CloudManagerURL" ] }
        },
		"UbuntuInstance": {
            "Description": "Ubuntu EC2 Instance deployed by Quick Start",
			"Condition" : "CreateUbuntuWorkload",
            "Value": {
                "Fn::GetAtt": [
                    "WorkloadStack",
                    "Outputs.UbuntuInstance"
                ]
            }
        },
		"UbuntuClientIP" : {
			"Condition": "CreateUbuntuWorkload",
			"Description" : "Public IP of Ubuntu instance",
            "Value": { "Fn::GetAtt": [ "WorkloadStack", "Outputs.UbuntuClientIP" ] }
        },
		"SQLServerInstance": {
            "Description": "SQL Server EC2 Instance deployed by Quick Start",
			"Condition" : "CreateSQLWorkload",
            "Value": {
                "Fn::GetAtt": [
                    "WorkloadStack",
                    "Outputs.SQLServerInstance"
                ]
            }
        },
        "SQLIPAddress": {
            "Description": "Public IP Address of SQL Server",
			"Condition" : "CreateSQLWorkload",
            "Value": {
                "Fn::GetAtt": [
                    "WorkloadStack",
                    "Outputs.SQLIPAddress"
                ]
            }
        }
	}
}